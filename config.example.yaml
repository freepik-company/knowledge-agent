# Knowledge Agent Configuration - Complete Example
# Copy this file to config.yaml and customize for your deployment
# Use environment variable references with ${VAR} or ${VAR:default} syntax

# ============================================================================
# Agent Identity
# ============================================================================
# Custom name for your agent (e.g., "Anton", "Ghost", "Cortex")
agent_name: Knowledge Agent

# ============================================================================
# Anthropic Configuration (Required)
# ============================================================================
anthropic:
  api_key: ${ANTHROPIC_API_KEY}  # Required
  model: claude-sonnet-4-5-20250929  # Default model

# ============================================================================
# Slack Configuration
# ============================================================================
slack:
  enabled: true  # Set to false for API-only mode
  bot_token: ${SLACK_BOT_TOKEN}
  signing_secret: ${SLACK_SIGNING_SECRET}  # Required for webhook mode
  app_token: ${SLACK_APP_TOKEN}  # Required for socket mode
  mode: webhook  # "webhook" (production) or "socket" (development)
  max_thread_messages: 50  # 0 = unlimited (not recommended)
  max_file_size: 10485760  # 10 MB
  max_images_per_thread: 10

# ============================================================================
# Database Configuration (Required)
# ============================================================================
postgres:
  url: ${POSTGRES_URL}  # postgres://user:pass@host:5432/dbname?sslmode=disable

redis:
  addr: ${REDIS_ADDR:localhost:6379}
  password: ${REDIS_PASSWORD:}
  ttl: 24h

# ============================================================================
# Ollama Configuration (for embeddings)
# ============================================================================
ollama:
  base_url: ${OLLAMA_BASE_URL:http://localhost:11434/v1}
  embedding_model: nomic-embed-text

# ============================================================================
# RAG Configuration
# ============================================================================
rag:
  chunk_size: 2000
  chunk_overlap: 1
  messages_per_chunk: 5
  similarity_threshold: 0.7
  max_results: 5
  # Knowledge Scope: "shared" (global), "channel" (per-channel), "user" (per-user)
  # Use "shared" for A2A integrations
  knowledge_scope: shared

# ============================================================================
# Response Processing
# ============================================================================
response_cleaner:
  enabled: true  # Remove agent narration from responses
  model: claude-haiku-4-5-20251001

context_summarizer:
  enabled: true  # Compress long contexts
  model: claude-haiku-4-5-20251001
  token_threshold: 8000  # Summarize when context exceeds this

# ============================================================================
# Server Configuration
# ============================================================================
server:
  agent_port: 8081
  slack_bot_port: 8080
  read_timeout: 30  # seconds
  write_timeout: 180  # seconds
  request_timeout: 120  # seconds
  trusted_proxies: []  # List of trusted proxy IPs/CIDRs

# ============================================================================
# Logging
# ============================================================================
log:
  level: info  # debug, info, warn, error
  format: console  # console or json
  output_path: stdout

# ============================================================================
# Authentication
# ============================================================================
auth:
  # Internal token for Slack Bridge -> Agent communication
  # Generate with: openssl rand -hex 32
  internal_token: ${INTERNAL_AUTH_TOKEN}

# API Keys for external access (A2A, external integrations)
# Format: key -> {caller_id, role}
# Roles: "write" (full access) or "read" (no save_to_memory)
api_keys:
  # Example:
  # ka_your_api_key:
  #   caller_id: external-service
  #   role: write

# ============================================================================
# Permissions
# ============================================================================
permissions:
  # Slack User IDs allowed to save to memory (empty = all allowed)
  allowed_slack_users: []
  # Caller IDs with admin permissions (bypass restrictions)
  admin_caller_ids:
    - root-agent

# ============================================================================
# Observability (Langfuse)
# ============================================================================
langfuse:
  enabled: false
  public_key: ${LANGFUSE_PUBLIC_KEY}
  secret_key: ${LANGFUSE_SECRET_KEY}
  host: ${LANGFUSE_HOST:https://cloud.langfuse.com}
  input_cost_per_1m: 3.0  # Claude Sonnet 4.5 input cost
  output_cost_per_1m: 15.0  # Claude Sonnet 4.5 output cost

# ============================================================================
# MCP (Model Context Protocol)
# ============================================================================
mcp:
  enabled: false
  retry:
    enabled: true
    max_retries: 3
    initial_delay: 500ms
  servers:
    # Example: Filesystem access
    - name: "filesystem"
      description: "Local filesystem operations"
      enabled: true
      transport_type: "command"
      command:
        path: "npx"
        args:
          - "-y"
          - "@modelcontextprotocol/server-filesystem"
          - "/workspace"
        # inherit_env: [CUSTOM_VAR]  # Inherit specific env vars
        # env:
        #   CUSTOM_VAR: value
      timeout: 30
      # tool_filter: [read_file, write_file]  # Filter specific tools

    # Example: SSE transport with auth
    # - name: "remote-mcp"
    #   description: "Remote MCP server"
    #   enabled: false
    #   transport_type: "sse"
    #   endpoint: "https://mcp.example.com/sse"
    #   auth:
    #     type: "bearer"
    #     token_env: "MCP_TOKEN"
    #   timeout: 30

# ============================================================================
# A2A (Agent-to-Agent Protocol)
# ============================================================================
a2a:
  enabled: false
  self_name: knowledge-agent  # This agent's identifier
  agent_url: http://localhost:8081  # Public URL for A2A discovery
  max_call_depth: 5
  polling: true  # Required for large responses

  # Context cleaner: summarizes context before sending to sub-agents
  context_cleaner:
    enabled: true
    model: claude-haiku-4-5-20251001

  # Retry configuration for A2A calls
  retry:
    enabled: true
    max_retries: 3
    initial_delay: 500ms

  # Sub-agents configuration
  sub_agents:
    # Example:
    # - name: "metrics-agent"
    #   description: "Analyzes metrics and dashboards"
    #   endpoint: "http://metrics-agent:9000"
    #   auth:
    #     type: "api_key"
    #     header: "X-API-Key"
    #     key_env: "METRICS_AGENT_API_KEY"

# ============================================================================
# Parallel Tool Execution
# ============================================================================
parallel:
  enabled: true
  max_parallelism: 5
  tool_timeout: 120s
  sequential_tools:
    - save_to_memory  # Should run after search_memory

# ============================================================================
# Prompt Configuration
# ============================================================================
prompt:
  # Option 1: Define prompt directly (recommended)
  # base_prompt: |
  #   You are a helpful assistant...

  # Option 2: Load from file
  # template_path: /path/to/prompt.txt

  # Option 3: Hot reload (development only, requires template_path)
  enable_hot_reload: false

# ============================================================================
# Tools Configuration
# ============================================================================
tools:
  web_fetch:
    timeout: 30s
    default_max_length: 10000
